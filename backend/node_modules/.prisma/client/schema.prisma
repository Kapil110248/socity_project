// schema.prisma

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  SUPER_ADMIN
  ADMIN
  RESIDENT
  GUARD
  VENDOR
  ACCOUNTANT
}

enum ComplaintStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum VisitorStatus {
  PENDING
  APPROVED
  CHECKED_IN
  CHECKED_OUT
  REJECTED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum PaymentMethod {
  CASH
  ONLINE
  UPI
  CHEQUE
}

model Society {
  id        Int      @id @default(autoincrement())
  name      String
  address   String?
  code      String   @unique // Unique code for society login/reg
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  units        Unit[]
  complaints   Complaint[]
  visitors     Visitor[]
  transactions Transaction[]
  notices      Notice[]
  vendors      Vendor[]
  amenities    Amenity[]
  parkingSlots ParkingSlot[]
}

model User {
  id         Int     @id @default(autoincrement())
  email      String  @unique
  password   String // Hashed
  name       String
  phone      String?
  role       Role    @default(RESIDENT)
  profileImg String?

  societyId Int?
  society   Society? @relation(fields: [societyId], references: [id])

  // Relations
  ownedUnits  Unit[] @relation("Owner")
  rentedUnits Unit[] @relation("Tenant")

  reportedComplaints Complaint[] @relation("ReportedBy")
  assignedComplaints Complaint[] @relation("AssignedTo")

  bookings AmenityBooking[]
  comments ComplaintComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Unit {
  id       Int    @id @default(autoincrement())
  block    String
  number   String
  floor    Int
  type     String // 2BHK, 3BHK, Villa
  areaSqFt Float

  societyId Int
  society   Society @relation(fields: [societyId], references: [id])

  ownerId Int?
  owner   User? @relation("Owner", fields: [ownerId], references: [id])

  tenantId Int?
  tenant   User? @relation("Tenant", fields: [tenantId], references: [id])

  visitors     Visitor[]
  parkingSlots ParkingSlot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([societyId, block, number])
}

model ParkingSlot {
  id     Int    @id @default(autoincrement())
  number String
  type   String // 4-Wheeler, 2-Wheeler
  status String // ALLOCATED, VACANT, VISITOR

  societyId Int
  society   Society @relation(fields: [societyId], references: [id])

  allocatedToUnitId Int?
  unit              Unit? @relation(fields: [allocatedToUnitId], references: [id])

  vehicleNumber String?

  createdAt DateTime @default(now())
}

model Complaint {
  id          Int             @id @default(autoincrement())
  title       String
  description String          @db.Text
  category    String // maintenance, electrical, plumbing, etc.
  priority    Priority        @default(MEDIUM)
  status      ComplaintStatus @default(OPEN)

  images Json? // Array of image URLs

  societyId Int
  society   Society @relation(fields: [societyId], references: [id])

  reportedById Int
  reportedBy   User @relation("ReportedBy", fields: [reportedById], references: [id])

  assignedToId Int?
  assignedTo   User? @relation("AssignedTo", fields: [assignedToId], references: [id])

  comments ComplaintComment[]
  timeline Json? // Array of {action, time, user} objects

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ComplaintComment {
  id          Int       @id @default(autoincrement())
  complaintId Int
  complaint   Complaint @relation(fields: [complaintId], references: [id])
  userId      Int
  user        User      @relation(fields: [userId], references: [id])
  message     String    @db.Text
  createdAt   DateTime  @default(now())
}

model Visitor {
  id        Int     @id @default(autoincrement())
  name      String
  phone     String
  vehicleNo String?
  purpose   String
  photo     String?

  status    VisitorStatus @default(PENDING)
  entryTime DateTime?
  exitTime  DateTime?

  societyId Int
  society   Society @relation(fields: [societyId], references: [id])

  visitingUnitId Int
  unit           Unit @relation(fields: [visitingUnitId], references: [id])

  idType   String? // Aadhar, DL
  idNumber String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transaction {
  id          Int             @id @default(autoincrement())
  type        TransactionType
  category    String // Maintenance, Parking, Salary
  amount      Float
  date        DateTime
  description String?

  paymentMethod PaymentMethod
  status        String // PAID, PENDING, OVERDUE

  societyId Int
  society   Society @relation(fields: [societyId], references: [id])

  invoiceNo    String?
  paidTo       String? // Vendor Name
  receivedFrom String? // Resident Name

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Vendor {
  id          Int     @id @default(autoincrement())
  name        String
  serviceType String
  contact     String
  email       String?
  address     String?
  active      Boolean @default(true)

  societyId Int
  society   Society @relation(fields: [societyId], references: [id])

  createdAt DateTime @default(now())
}

model Notice {
  id       Int    @id @default(autoincrement())
  title    String
  content  String @db.Text
  audience String // ALL, OWNERS, TENANTS

  societyId Int
  society   Society @relation(fields: [societyId], references: [id])

  createdAt DateTime  @default(now())
  expiresAt DateTime?
}

model Amenity {
  id             Int     @id @default(autoincrement())
  name           String
  description    String?
  chargesPerHour Float   @default(0)

  societyId Int
  society   Society @relation(fields: [societyId], references: [id])

  bookings AmenityBooking[]

  createdAt DateTime @default(now())
}

model AmenityBooking {
  id        Int     @id @default(autoincrement())
  amenityId Int
  amenity   Amenity @relation(fields: [amenityId], references: [id])

  userId Int
  user   User @relation(fields: [userId], references: [id])

  startTime  DateTime
  endTime    DateTime
  status     String // CONFIRMED, CANCELLED
  amountPaid Float    @default(0)

  createdAt DateTime @default(now())
}
