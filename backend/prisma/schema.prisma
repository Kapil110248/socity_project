// schema.prisma

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  SUPER_ADMIN
  ADMIN
  RESIDENT
  GUARD
  VENDOR
  ACCOUNTANT
  INDIVIDUAL
  COMMUNITY_MANAGER
  COMMITTEE
}

enum ComplaintStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum VisitorStatus {
  PENDING
  APPROVED
  CHECKED_IN
  CHECKED_OUT
  REJECTED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum PaymentMethod {
  CASH
  ONLINE
  UPI
  CHEQUE
}

enum SocietyStatus {
  ACTIVE
  PENDING
  INACTIVE
  SUSPENDED
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING
}

enum VendorStatus {
  ACTIVE
  SUSPENDED
  PENDING
}

enum SubscriptionPlan {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

model Society {
  id          Int      @id @default(autoincrement())
  name        String
  address     String?
  city        String?
  state       String?
  pincode     String?
  code        String   @unique // Unique code for society login/reg
  status      SocietyStatus @default(PENDING)
  subscriptionPlan SubscriptionPlan @default(BASIC)
  expectedUnits Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  units       Unit[]
  complaints  Complaint[]
  visitors    Visitor[]
  transactions Transaction[]
  notices     Notice[]
  vendors     Vendor[]
  amenities   Amenity[]
  parkingSlots ParkingSlot[]
  platformInvoices PlatformInvoice[]
  meetings    Meeting[]
  assets      Asset[]
  documents   Document[]
  parcels     Parcel[]
  events      Event[]
  purchaseRequests PurchaseRequest[]
  emergencyAlerts  EmergencyAlert[]
  emergencyContacts EmergencyContact[]
  serviceInquiries  ServiceInquiry[]
  conversations     Conversation[]
}

model User {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String   // Hashed
  name        String
  phone       String?
  role        Role     @default(RESIDENT)
  status      UserStatus @default(ACTIVE)
  profileImg  String?
  
  roleId      Int?
  roleModel   RoleModel? @relation(fields: [roleId], references: [id])
  
  sessions    UserSession[]
  
  societyId   Int?
  society     Society? @relation(fields: [societyId], references: [id])
  
  // Relations
  ownedUnits  Unit[]   @relation("Owner")
  rentedUnits Unit[]   @relation("Tenant")
  
  reportedComplaints Complaint[] @relation("ReportedBy")
  assignedComplaints Complaint[] @relation("AssignedTo")
  
  bookings    AmenityBooking[]
  comments    ComplaintComment[]
  purchaseRequests PurchaseRequest[]
  emergencyAlerts  EmergencyAlert[]
  serviceInquiries ServiceInquiry[]
  
  // Chat Relations
  conversations Conversation[] @relation("UserConversations")
  sentMessages ChatMessage[] @relation("SentMessages")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RoleModel {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  permissions RolePermission[]
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Permission {
  id          String   @id // e.g. "manage_residents"
  label       String
  description String?
  roles       RolePermission[]
}

model RolePermission {
  roleId       Int
  role         RoleModel @relation(fields: [roleId], references: [id])
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

model UserSession {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  device      String?
  ipAddress   String?
  lastActive  DateTime @default(now())
  token       String   @unique @db.VarChar(500)
  createdAt   DateTime @default(now())
}

model Unit {
  id          Int      @id @default(autoincrement())
  block       String
  number      String
  floor       Int
  type        String   // 2BHK, 3BHK, Villa
  areaSqFt    Float
  
  societyId   Int
  society     Society  @relation(fields: [societyId], references: [id])
  
  ownerId     Int?
  owner       User?    @relation("Owner", fields: [ownerId], references: [id])
  
  tenantId    Int?
  tenant      User?    @relation("Tenant", fields: [tenantId], references: [id])
  
  visitors    Visitor[]
  parkingSlots ParkingSlot[]
  parcels     Parcel[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([societyId, block, number])
}

model ParkingSlot {
  id          Int      @id @default(autoincrement())
  number      String
  type        String   // 4-Wheeler, 2-Wheeler
  status      String   // ALLOCATED, VACANT, VISITOR
  
  societyId   Int
  society     Society  @relation(fields: [societyId], references: [id])
  
  allocatedToUnitId Int?
  unit        Unit?    @relation(fields: [allocatedToUnitId], references: [id])
  
  vehicleNumber String?
  
  createdAt   DateTime @default(now())
}

model Complaint {
  id          Int      @id @default(autoincrement())
  title       String
  description String   @db.Text
  category    String   // maintenance, electrical, plumbing, etc.
  priority    Priority @default(MEDIUM)
  status      ComplaintStatus @default(OPEN)
  
  isPrivate       Boolean  @default(false)
  escalatedToTech Boolean  @default(false)
  
  images      Json?    // Array of image URLs
  
  societyId   Int
  society     Society  @relation(fields: [societyId], references: [id])
  
  reportedById Int
  reportedBy   User    @relation("ReportedBy", fields: [reportedById], references: [id])
  
  assignedToId Int?
  assignedTo   User?   @relation("AssignedTo", fields: [assignedToId], references: [id])
  
  comments    ComplaintComment[]
  timeline    Json?    // Array of {action, time, user} objects
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ComplaintComment {
  id          Int      @id @default(autoincrement())
  complaintId Int
  complaint   Complaint @relation(fields: [complaintId], references: [id])
  userId      Int
  user        User      @relation(fields: [userId], references: [id])
  message     String    @db.Text
  createdAt   DateTime @default(now())
}

model Visitor {
  id          Int      @id @default(autoincrement())
  name        String
  phone       String
  vehicleNo   String?
  purpose     String
  photo       String?
  
  status      VisitorStatus @default(PENDING)
  entryTime   DateTime?
  exitTime    DateTime?
  
  societyId   Int
  society     Society  @relation(fields: [societyId], references: [id])
  
  visitingUnitId Int
  unit           Unit    @relation(fields: [visitingUnitId], references: [id])
  
  idType      String?  // Aadhar, DL
  idNumber    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Transaction {
  id          Int      @id @default(autoincrement())
  type        TransactionType
  category    String   // Maintenance, Parking, Salary
  amount      Float
  date        DateTime
  description String?
  
  paymentMethod PaymentMethod
  status      String   // PAID, PENDING, OVERDUE
  
  societyId   Int
  society     Society  @relation(fields: [societyId], references: [id])
  
  invoiceNo   String?
  paidTo      String?  // Vendor Name
  receivedFrom String? // Resident Name
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Vendor {
  id          Int      @id @default(autoincrement())
  name        String
  serviceType String
  contact     String
  email       String?
  address     String?
  status      VendorStatus @default(ACTIVE)
  
  societyId   Int?
  society     Society?  @relation(fields: [societyId], references: [id])
  
  payouts     VendorPayout[]
  createdAt   DateTime @default(now())
}

model VendorPayout {
  id                Int      @id @default(autoincrement())
  vendorId          Int
  vendor            Vendor   @relation(fields: [vendorId], references: [id])
  vendorName        String
  societyId         Int?
  societyName       String?
  dealValue         Float
  commissionPercent Float
  payableAmount     Float
  status            String   @default("PENDING") // PAID, PENDING
  remarks           String?  @db.Text
  date              DateTime @default(now())
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model ServiceCategory {
  id          String   @id // slug e.g. "plumbing"
  name        String
  description String   @db.Text
  icon        String
  color       String
  variants    ServiceVariant[]
}

model ServiceVariant {
  id          String   @id @default(uuid())
  name        String
  price       String
  description String?  @db.Text
  categoryId  String
  category    ServiceCategory @relation(fields: [categoryId], references: [id])
}

model ServiceInquiry {
  id           String   @id @default(uuid())
  residentName String
  unit         String
  phone        String?
  serviceName  String
  serviceId    String
  status       String   @default("pending")
  vendorName   String?
  vendorId     String?
  source       String?  @default("society") // society, resident, individual
  type         String?  @default("service") // service, callback
  preferredDate String?
  preferredTime String?
  notes         String?  @db.Text
  
  societyId    Int?
  society      Society? @relation(fields: [societyId], references: [id])
  
  residentId   Int?
  resident     User?    @relation(fields: [residentId], references: [id])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model EmergencyLog {
  id           String   @id @default(uuid())
  timestamp    DateTime @default(now())
  visitorName  String
  visitorPhone String
  residentName String
  unit         String
  isEmergency  Boolean  @default(false)
  reason       String?  @db.Text
  barcodeId    String
  societyId    Int?
}

model EmergencyBarcode {
  id           String   @id // custom id
  residentName String
  unit         String
  phone        String
  label        String?  // Description for the barcode
  type         String?  // property, vehicle, etc.
  status       String   @default("active")
  qrCodeUrl    String
  createdAt    DateTime @default(now())
  societyId    Int?
}

model EmergencyAlert {
  id           Int      @id @default(autoincrement())
  type         String   // fire, medical, security, disaster, panic
  unit         String?
  description  String?  @db.Text
  status       String   @default("active") // active, resolved
  resolution   String?  @db.Text
  
  societyId    Int
  society      Society  @relation(fields: [societyId], references: [id])
  
  userId       Int
  user         User     @relation(fields: [userId], references: [id])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model EmergencyContact {
  id           Int      @id @default(autoincrement())
  name         String
  phone        String
  category     String   // security, fire, medical, police, custom
  available    Boolean  @default(true)
  
  societyId    Int
  society      Society  @relation(fields: [societyId], references: [id])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Notice {
  id          Int      @id @default(autoincrement())
  title       String
  content     String   @db.Text
  audience    String   // ALL, OWNERS, TENANTS
  
  societyId   Int
  society     Society  @relation(fields: [societyId], references: [id])
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
}

model Amenity {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  chargesPerHour Float @default(0)
  
  societyId   Int
  society     Society  @relation(fields: [societyId], references: [id])
  
  bookings    AmenityBooking[]
  
  createdAt   DateTime @default(now())
}

model AmenityBooking {
  id          Int      @id @default(autoincrement())
  amenityId   Int
  amenity     Amenity  @relation(fields: [amenityId], references: [id])
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  
  startTime   DateTime
  endTime     DateTime
  status      String   // CONFIRMED, CANCELLED
  amountPaid  Float    @default(0)
  
  createdAt   DateTime @default(now())
}

model SystemSetting {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String @db.Text
}

model BillingPlan {
  id          Int      @id @default(autoincrement())
  name        String
  type        String   // Monthly, Quarterly, Yearly, One-Time
  price       String
  description String?  @db.Text
  status      String   @default("active") // active, inactive
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PlatformInvoice {
  id          Int      @id @default(autoincrement())
  invoiceNo   String   @unique
  societyId   Int
  society     Society  @relation(fields: [societyId], references: [id])
  amount      Float
  status      String   @default("PENDING") // PAID, PENDING, OVERDUE
  issueDate   DateTime @default(now())
  dueDate     DateTime
  paidDate    DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== NEW ADMIN MODELS ====================

model Meeting {
  id          Int      @id @default(autoincrement())
  title       String
  description String?  @db.Text
  date        DateTime
  time        String
  location    String
  attendees   Json?
  status      String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED
  societyId   Int
  society     Society  @relation(fields: [societyId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Asset {
  id           Int      @id @default(autoincrement())
  name         String
  category     String
  value        Float
  purchaseDate DateTime
  status       String   @default("ACTIVE") // ACTIVE, UNDER_REPAIR, DISPOSED
  societyId    Int
  society      Society  @relation(fields: [societyId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Document {
  id        Int      @id @default(autoincrement())
  title     String
  category  String   // Legal, Financial, Notices
  fileUrl   String
  societyId Int
  society   Society  @relation(fields: [societyId], references: [id])
  createdAt DateTime @default(now())
}

model Parcel {
  id            Int       @id @default(autoincrement())
  unitId        Int
  unit          Unit      @relation(fields: [unitId], references: [id])
  courierName   String
  trackingNumber String?
  description   String?
  receivedBy    String?
  status        String    @default("PENDING") // PENDING, COLLECTED
  collectedBy   String?
  collectedAt   DateTime?
  societyId     Int
  society       Society   @relation(fields: [societyId], references: [id])
  createdAt     DateTime  @default(now())
}

model Event {
  id          Int      @id @default(autoincrement())
  title       String
  description String?  @db.Text
  date        DateTime
  time        String?
  location    String?
  category    String?  // Festival, Meeting, Sports
  status      String   @default("UPCOMING") // UPCOMING, ONGOING, COMPLETED
  societyId   Int
  society     Society  @relation(fields: [societyId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
model PurchaseRequest {
  id           Int      @id @default(autoincrement())
  title        String
  description  String?
  amount       Float
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  societyId    Int
  society      Society  @relation(fields: [societyId], references: [id])
  requestedById Int
  requestedBy  User     @relation(fields: [requestedById], references: [id])
}
model Conversation {
  id          Int      @id @default(autoincrement())
  societyId   Int
  society     Society  @relation(fields: [societyId], references: [id])
  
  type        String   // SUPPORT_ADMIN, SUPPORT_MAINTENANCE, SUPPORT_SECURITY, SUPPORT_COMMITTEE, SUPPORT_ACCOUNTS
  participantId Int?   // The Resident/User who started the support chat
  participant  User?   @relation("UserConversations", fields: [participantId], references: [id])
  
  messages    ChatMessage[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([societyId, type, participantId])
}

model ChatMessage {
  id             Int      @id @default(autoincrement())
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  
  senderId       Int
  sender         User     @relation("SentMessages", fields: [senderId], references: [id])
  
  content        String   @db.Text
  attachments    Json?    // Array of files/images
  status         String   @default("sent") // sent, delivered, read
  
  createdAt      DateTime @default(now())
}
